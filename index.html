<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AskChef ‚Äî AI Cooking Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  :root {
    --bg: #09090b;
    --bg-card: #111113;
    --bg-input: #18181b;
    --border: #27272a;
    --border-light: #3f3f46;
    --text: #fafafa;
    --text-muted: #a1a1aa;
    --text-dim: #71717a;
    --indigo: #6366f1;
    --indigo-light: #818cf8;
    --indigo-dim: #4f46e5;
    --green: #22c55e;
    --amber: #f59e0b;
    --orange: #ea580c;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 24px;
    background: var(--bg-card);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .header-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .logo {
    width: 40px; height: 40px;
    background: linear-gradient(135deg, var(--amber), var(--orange));
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
  }
  .app-name {
    font-size: 18px;
    font-weight: 700;
    letter-spacing: -0.02em;
  }
  .app-sub {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 1px;
  }

  /* Model toggle */
  .model-toggle {
    display: flex;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 3px;
    gap: 2px;
  }
  .model-btn {
    padding: 6px 16px;
    border: none;
    border-radius: 8px;
    font-family: inherit;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    background: transparent;
    color: var(--text-dim);
  }
  .model-btn.active {
    background: var(--indigo);
    color: #fff;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
  }
  .model-btn:hover:not(.active) {
    color: var(--text-muted);
  }

  .header-right {
    display: flex; align-items: center; gap: 16px;
  }
  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--green);
  }
  .status-text {
    font-size: 11px;
    color: var(--text-dim);
  }
  .pb-badge {
    display: flex; align-items: center; gap: 6px;
    font-size: 11px; color: var(--text-dim);
    padding: 4px 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
  }
  .pb-badge svg { width: 14px; height: 14px; }

  /* ‚îÄ‚îÄ Chat area ‚îÄ‚îÄ */
  .chat-area {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  .chat-area::-webkit-scrollbar { width: 6px; }
  .chat-area::-webkit-scrollbar-track { background: transparent; }
  .chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* Welcome screen */
  .welcome {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
    text-align: center;
    gap: 16px;
    opacity: 0.9;
  }
  .welcome-icon {
    font-size: 64px;
  }
  .welcome h2 {
    font-size: 28px;
    font-weight: 700;
    letter-spacing: -0.02em;
  }
  .welcome p {
    color: var(--text-dim);
    font-size: 15px;
    max-width: 400px;
    line-height: 1.6;
  }
  .suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
    justify-content: center;
  }
  .suggestion {
    padding: 8px 16px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 13px;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
  }
  .suggestion:hover {
    border-color: var(--indigo);
    color: var(--text);
    background: rgba(99, 102, 241, 0.08);
  }

  /* Messages */
  .msg-row {
    display: flex;
    gap: 10px;
    max-width: 720px;
    animation: msgIn 0.3s ease;
  }
  @keyframes msgIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .msg-row.user { align-self: flex-end; flex-direction: row-reverse; }
  .msg-row.bot { align-self: flex-start; }

  .msg-avatar {
    width: 32px; height: 32px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
    margin-top: 2px;
  }
  .msg-row.user .msg-avatar {
    background: var(--indigo);
    font-size: 13px; font-weight: 600; color: #fff;
  }
  .msg-row.bot .msg-avatar {
    background: linear-gradient(135deg, var(--amber), var(--orange));
  }

  .msg-bubble {
    padding: 12px 16px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.6;
  }
  .msg-row.user .msg-bubble {
    background: var(--indigo);
    color: #fff;
    border-bottom-right-radius: 4px;
  }
  .msg-row.bot .msg-bubble {
    background: var(--bg-card);
    border: 1px solid var(--border);
    color: var(--text);
    border-bottom-left-radius: 4px;
  }
  .msg-bubble b, .msg-bubble strong {
    font-weight: 600;
    color: #fff;
  }
  .msg-row.bot .msg-bubble b, .msg-row.bot .msg-bubble strong {
    color: var(--text);
  }
  .msg-meta {
    font-size: 10px;
    color: var(--text-dim);
    margin-top: 4px;
    padding: 0 4px;
  }
  .msg-row.user .msg-meta { text-align: right; }

  /* Typing indicator */
  .typing-row {
    display: flex;
    gap: 10px;
    align-self: flex-start;
    animation: msgIn 0.3s ease;
  }
  .typing-dots {
    display: flex;
    gap: 4px;
    padding: 14px 18px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    border-bottom-left-radius: 4px;
  }
  .typing-dot {
    width: 7px; height: 7px;
    background: var(--text-dim);
    border-radius: 50%;
    animation: bounce 1.2s infinite;
  }
  .typing-dot:nth-child(2) { animation-delay: 0.15s; }
  .typing-dot:nth-child(3) { animation-delay: 0.3s; }
  @keyframes bounce {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
    30% { transform: translateY(-5px); opacity: 1; }
  }

  /* ‚îÄ‚îÄ Native Ad Card ‚îÄ‚îÄ */
  .ad-card {
    max-width: 720px;
    align-self: flex-start;
    margin-left: 42px;
    background: linear-gradient(135deg, #12121a, #151520);
    border: 1px solid rgba(99, 102, 241, 0.2);
    border-radius: 14px;
    padding: 16px 18px;
    animation: adIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  }
  @keyframes adIn {
    from { opacity: 0; transform: translateY(10px) scale(0.98); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  .ad-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 10px;
    font-weight: 700;
    color: var(--indigo-light);
    letter-spacing: 0.8px;
    margin-bottom: 10px;
  }
  .ad-badge svg { width: 12px; height: 12px; flex-shrink: 0; }
  .ad-content {
    display: flex;
    gap: 14px;
    align-items: flex-start;
  }
  .ad-image {
    width: 80px; height: 80px;
    border-radius: 10px;
    background: var(--bg-input);
    object-fit: cover;
    flex-shrink: 0;
    display: none;
  }
  .ad-image.loaded { display: block; }
  .ad-text { flex: 1; }
  .ad-headline {
    font-size: 15px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 4px;
    line-height: 1.3;
  }
  .ad-desc {
    font-size: 12.5px;
    color: var(--text-muted);
    line-height: 1.5;
    margin-bottom: 12px;
  }
  .ad-cta {
    display: inline-block;
    padding: 7px 18px;
    background: var(--indigo);
    color: #fff;
    font-size: 12px;
    font-weight: 600;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.2s;
    cursor: pointer;
  }
  .ad-cta:hover {
    background: var(--indigo-dim);
    transform: translateY(-1px);
  }
  .ad-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    padding-top: 8px;
    border-top: 1px solid rgba(255,255,255,0.04);
  }
  .ad-powered {
    font-size: 9px;
    color: var(--text-dim);
    opacity: 0.7;
  }
  .ad-close {
    font-size: 9px;
    color: var(--text-dim);
    opacity: 0.5;
    cursor: pointer;
    background: none;
    border: none;
    font-family: inherit;
  }
  .ad-close:hover { opacity: 1; }

  /* ‚îÄ‚îÄ Input area ‚îÄ‚îÄ */
  .input-area {
    padding: 16px 24px 20px;
    background: var(--bg-card);
    border-top: 1px solid var(--border);
    flex-shrink: 0;
  }
  .input-row {
    display: flex;
    gap: 10px;
    max-width: 720px;
    margin: 0 auto;
  }
  .input-field {
    flex: 1;
    padding: 12px 18px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 14px;
    font-family: inherit;
    font-size: 14px;
    color: var(--text);
    outline: none;
    transition: border-color 0.2s;
  }
  .input-field:focus {
    border-color: var(--indigo);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.12);
  }
  .input-field::placeholder { color: var(--text-dim); }
  .send-btn {
    width: 46px; height: 46px;
    background: var(--indigo);
    border: none;
    border-radius: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  .send-btn:hover { background: var(--indigo-dim); transform: scale(1.05); }
  .send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
  .send-btn svg { width: 20px; height: 20px; stroke: #fff; fill: none; }

  .input-hint {
    text-align: center;
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 8px;
    opacity: 0.6;
  }

  /* ‚îÄ‚îÄ Config banner ‚îÄ‚îÄ */
  .config-banner {
    background: rgba(245, 158, 11, 0.08);
    border-bottom: 1px solid rgba(245, 158, 11, 0.15);
    padding: 10px 24px;
    font-size: 12px;
    color: var(--amber);
    text-align: center;
    display: none;
  }
  .config-banner.visible { display: block; }
  .config-banner code {
    background: rgba(245, 158, 11, 0.12);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 11px;
  }
</style>
</head>
<body>

<header class="header">
  <div class="header-left">
    <div class="logo">üç≥</div>
    <div>
      <div class="app-name">AskChef</div>
      <div class="app-sub">AI Cooking Assistant</div>
    </div>
  </div>
  <div class="model-toggle">
    <button class="model-btn active" data-model="claude" onclick="setModel('claude')">Claude</button>
    <button class="model-btn" data-model="chatgpt" onclick="setModel('chatgpt')">ChatGPT</button>
  </div>
  <div class="header-right">
    <div class="pb-badge">
      <svg viewBox="0 0 16 16" fill="none"><rect x="1" y="2" width="4" height="12" rx="1" fill="#6366f1"/><rect x="6" y="5" width="4" height="9" rx="1" fill="#818cf8"/><rect x="11" y="1" width="4" height="13" rx="1" fill="#a78bfa"/></svg>
      Ads by PromptBid
    </div>
    <div style="display:flex;align-items:center;gap:6px;">
      <div class="status-dot" id="statusDot"></div>
      <span class="status-text" id="statusText">Connected</span>
    </div>
  </div>
</header>

<div class="config-banner" id="configBanner">
  API keys not configured. Set <code>ANTHROPIC_API_KEY</code> or <code>OPENAI_API_KEY</code> + <code>PROMPTBID_API_KEY</code> to enable live responses.
</div>

<div class="chat-area" id="chatArea">
  <div class="welcome" id="welcome">
    <div class="welcome-icon">üç≥</div>
    <h2>What should we cook?</h2>
    <p>I'm your AI cooking assistant. Ask me about recipes, meal prep, ingredient swaps, or cooking techniques.</p>
    <div class="suggestions">
      <button class="suggestion" onclick="sendSuggestion(this)">Quick weeknight dinner ideas</button>
      <button class="suggestion" onclick="sendSuggestion(this)">How to meal prep for the week</button>
      <button class="suggestion" onclick="sendSuggestion(this)">Best homemade pizza dough recipe</button>
      <button class="suggestion" onclick="sendSuggestion(this)">Healthy high-protein lunches</button>
    </div>
  </div>
</div>

<div class="input-area">
  <div class="input-row">
    <input
      type="text"
      class="input-field"
      id="messageInput"
      placeholder="Ask me anything about cooking..."
      autocomplete="off"
      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"
    >
    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
      <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    </button>
  </div>
  <div class="input-hint">Powered by Claude &amp; ChatGPT ¬∑ Ads served by PromptBid</div>
</div>

<script>
let sessionId = null;
let currentModel = 'claude';
let sending = false;

const chatArea = document.getElementById('chatArea');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const welcome = document.getElementById('welcome');

// Check server health on load
fetch('/health').then(r => r.json()).then(data => {
  if (!data.claude_configured && !data.chatgpt_configured) {
    document.getElementById('configBanner').classList.add('visible');
    document.getElementById('statusDot').style.background = '#f59e0b';
    document.getElementById('statusText').textContent = 'No AI key';
  }
  if (!data.promptbid_configured) {
    document.getElementById('statusDot').style.background = '#f59e0b';
    document.getElementById('statusText').textContent = 'No PB key';
  }
  // Auto-select available model
  if (!data.claude_configured && data.chatgpt_configured) setModel('chatgpt');
}).catch(() => {
  document.getElementById('statusDot').style.background = '#f43f5e';
  document.getElementById('statusText').textContent = 'Offline';
});

function setModel(model) {
  currentModel = model;
  document.querySelectorAll('.model-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.model === model);
  });
}

function sendSuggestion(btn) {
  messageInput.value = btn.textContent;
  sendMessage();
}

async function sendMessage() {
  const text = messageInput.value.trim();
  if (!text || sending) return;

  sending = true;
  sendBtn.disabled = true;
  messageInput.value = '';

  // Hide welcome
  if (welcome) welcome.style.display = 'none';

  // Add user message
  addMessage('user', text);

  // Show typing indicator
  const typingEl = addTyping();

  try {
    const resp = await fetch('/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: text,
        session_id: sessionId,
        model: currentModel,
      }),
    });

    const data = await resp.json();
    sessionId = data.session_id;

    // Remove typing indicator
    typingEl.remove();

    // Add bot response
    addMessage('bot', data.response, data.model);

    // Show ad if returned
    if (data.ad) {
      setTimeout(() => addAd(data.ad), 600);
    }

  } catch (err) {
    typingEl.remove();
    addMessage('bot', '_Could not reach server. Make sure the backend is running on port 3001._', 'error');
  }

  sending = false;
  sendBtn.disabled = false;
  messageInput.focus();
}

function addMessage(role, text, model) {
  const row = document.createElement('div');
  row.className = `msg-row ${role}`;

  const avatar = document.createElement('div');
  avatar.className = 'msg-avatar';
  avatar.textContent = role === 'user' ? 'You' : 'üç≥';

  const col = document.createElement('div');

  const bubble = document.createElement('div');
  bubble.className = 'msg-bubble';
  // Simple markdown-like formatting
  bubble.innerHTML = text
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/_(.*?)_/g, '<em>$1</em>')
    .replace(/\n/g, '<br>');

  col.appendChild(bubble);

  if (role === 'bot' && model) {
    const meta = document.createElement('div');
    meta.className = 'msg-meta';
    meta.textContent = model === 'claude' ? 'via Claude' : model === 'chatgpt' ? 'via ChatGPT' : '';
    col.appendChild(meta);
  }

  row.appendChild(avatar);
  row.appendChild(col);
  chatArea.appendChild(row);
  chatArea.scrollTop = chatArea.scrollHeight;
  return row;
}

function addTyping() {
  const row = document.createElement('div');
  row.className = 'typing-row';

  const avatar = document.createElement('div');
  avatar.className = 'msg-avatar';
  avatar.style.background = 'linear-gradient(135deg, var(--amber), var(--orange))';
  avatar.textContent = 'üç≥';

  const dots = document.createElement('div');
  dots.className = 'typing-dots';
  dots.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';

  row.appendChild(avatar);
  row.appendChild(dots);
  chatArea.appendChild(row);
  chatArea.scrollTop = chatArea.scrollHeight;
  return row;
}

function addAd(ad) {
  const card = document.createElement('div');
  card.className = 'ad-card';

  let imageHtml = '';
  if (ad.image_url) {
    imageHtml = `<img class="ad-image" src="${ad.image_url}" onerror="this.style.display='none'" onload="this.classList.add('loaded')" alt="">`;
  }

  card.innerHTML = `
    <div class="ad-badge">
      <svg viewBox="0 0 16 16" fill="none"><rect x="1" y="2" width="4" height="12" rx="1" fill="#6366f1"/><rect x="6" y="5" width="4" height="9" rx="1" fill="#818cf8"/><rect x="11" y="1" width="4" height="13" rx="1" fill="#a78bfa"/></svg>
      SPONSORED
    </div>
    <div class="ad-content">
      ${imageHtml}
      <div class="ad-text">
        <div class="ad-headline">${escHtml(ad.headline)}</div>
        <div class="ad-desc">${escHtml(ad.description)}</div>
        <a class="ad-cta" href="${escHtml(ad.cta_url || '#')}" target="_blank" rel="noopener"
           onclick="trackClick('${ad.impression_id}')">${escHtml(ad.cta_text || 'Learn More')}</a>
      </div>
    </div>
    <div class="ad-footer">
      <span class="ad-powered">Served by PromptBid ¬∑ Based on conversation context</span>
      <button class="ad-close" onclick="this.closest('.ad-card').remove()">Dismiss</button>
    </div>
  `;

  chatArea.appendChild(card);
  chatArea.scrollTop = chatArea.scrollHeight;

  // Fire impression pixel
  if (ad.imp_tracker) {
    new Image().src = ad.imp_tracker;
  }
}

function trackClick(impressionId) {
  fetch('/click', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ impression_id: impressionId }),
  }).catch(() => {});
}

function escHtml(s) {
  const div = document.createElement('div');
  div.textContent = s || '';
  return div.innerHTML;
}

// Focus input on load
messageInput.focus();
</script>
</body>
</html>
